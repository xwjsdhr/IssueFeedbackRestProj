<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xwj.util.sql_mapper_user">

	<sql id="userTable">t_user tu</sql>
	
	<sql id="userSql">
		SELECT 
		tu.id AS userId,
		tu.user_name AS userName,
		tu.real_name AS realName,
		tu.password AS password,
		tu.dept_id AS deptId
		 FROM 
		 <include refid="userTable"/>
	</sql>
	<!-- 获取指定id的用户 -->
	<select id="getUserById" parameterType="Integer" resultMap="userResultMap">
		 <include refid="userSql"></include>
		  WHERE tu.id = #{id}
	</select>
	 <!-- 全部用户 -->
	<select id="getAllUsers" resultMap="userResultMap">
		<include refid="userSql"></include>
	</select>
	
	<!-- 检查用户名是否存在 -->
	<select id="checkUsername" parameterType="String" resultMap="userResultMap1">
		SELECT 
		tu.id AS userId,
		tu.user_name AS userName,
		tu.real_name AS realName,
		tu.password AS password,
		tu.dept_id AS deptId
		 FROM 
		 <include refid="userTable"/>
		  WHERE tu.user_name = #{username}
	</select>
	<!-- 登录用户 -->
	<select id="login" parameterType="com.xwj.entity.User" resultMap="userResultMap">
		SELECT 
		tu.id AS userId,
		tu.user_name AS userName,
		tu.real_name AS realName,
		tu.password AS password,
		tu.dept_id AS deptId,
		td.dept_name AS deptName,
		tp.permission_name AS perName,
		tp.id AS perId
		 FROM 
		 <include refid="userTable"/>
		 LEFT JOIN 
		 t_dept td
		 ON 
		 tu.dept_id = td.id
		 LEFT JOIN 
		 t_dept_permission tdp 
		 ON tdp.dept_id = td.id
		 LEFT JOIN t_permission tp
		 ON tp.id = tdp.permission_id
		 
		 WHERE tu.user_name = #{username} and tu.password = #{password}
	</select>
	<!-- 添加用户 -->
	<insert id="insertUser" parameterType="com.xwj.entity.User">
		insert into t_user(user_name,password,dept_id,real_name) values(#{username}, #{password}, #{dept.id},
				#{realName});
	</insert>
	
	<resultMap type="com.xwj.entity.User" id="userResultMap">
		<result column="userName" property="username" />
		<result column="password" property="password" />
		<result column="realName" property="realName" />
		<result column="userId" property="id"/>

		<association property="dept" javaType="com.xwj.entity.Dept">
			<result column="deptId" property="id" />
			<result column="deptName" property="deptName" />
			<collection property="permissions" ofType="String" >
				<result property="permission" column="perId"/>
			</collection>
		</association>
	</resultMap>
	
	<resultMap type="com.xwj.entity.User" id="userResultMap1">
		<result column="userName" property="username" />
		<result column="password" property="password" />
		<result column="realName" property="realName" />
		<result column="userId" property="id"/>

		
	</resultMap>

</mapper>